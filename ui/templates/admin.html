<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>RAG Chatbot Admin</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
  <style>
    :root {
      --bg: #0a0e27;
      --bg-secondary: #0f1535;
      --panel: #141b3c;
      --panel-light: #1a2347;
      --border: #253560;
      --border-light: #2d4373;
      --ink: #e5e7eb;
      --ink-strong: #f3f4f6;
      --muted: #9ca3af;
      --primary: #6366f1;
      --primary-strong: #4f46e5;
      --accent: #14b8a6;
      --success: #10b981;
      --warning: #f59e0b;
      --shadow: 0 24px 64px rgba(0, 0, 0, 0.4);
      --shadow-sm: 0 8px 24px rgba(0, 0, 0, 0.25);
      --radius: 18px;
      --gradient-primary: linear-gradient(135deg, #6366f1 0%, #14b8a6 100%);
      --gradient-secondary: linear-gradient(135deg, #ec4899 0%, #f59e0b 100%);
      --gradient-tertiary: linear-gradient(135deg, #06b6d4 0%, #8b5cf6 100%);
    }
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body {
      font-family: "Inter", "Segoe UI", sans-serif;
      background: linear-gradient(135deg, #0a0e27 0%, #0f1535 50%, #141b3c 100%);
      color: var(--ink);
      min-height: 100vh;
      padding: 40px 20px 64px;
    }
    .page { max-width: 1320px; margin: 0 auto; display: flex; gap: 24px; }
    
    .sidebar {
      position: sticky;
      top: 20px;
      align-self: flex-start;
      width: 260px;
      background: var(--panel);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      padding: 20px 18px;
      box-shadow: var(--shadow-sm);
      backdrop-filter: blur(10px);
    }
    .sidebar h2 { font-size: 0.95rem; letter-spacing: 0.04em; margin-bottom: 14px; color: var(--muted); font-weight: 700; text-transform: uppercase; }
    .nav { display: grid; gap: 8px; }
    .nav a {
      text-decoration: none;
      color: var(--ink);
      padding: 11px 14px;
      border: 1px solid var(--border);
      border-radius: 12px;
      background: var(--panel-light);
      transition: all 200ms cubic-bezier(0.4, 0, 0.2, 1);
      font-weight: 600;
      font-size: 0.95rem;
    }
    .nav a:hover { 
      transform: translateX(4px);
      border-color: var(--primary);
      background: rgba(59, 130, 246, 0.1);
      color: var(--primary);
    }

    .content { flex: 1; display: flex; flex-direction: column; gap: 20px; }
    
    header.hero {
      background: var(--gradient-primary);
      border-radius: var(--radius);
      padding: 32px;
      box-shadow: var(--shadow);
      display: grid;
      grid-template-columns: 2fr 1.2fr;
      gap: 20px;
      position: relative;
      overflow: hidden;
    }
    header.hero::before {
      content: '';
      position: absolute;
      top: -50%;
      right: -10%;
      width: 400px;
      height: 400px;
      background: radial-gradient(circle, rgba(255,255,255,0.08), transparent);
      border-radius: 50%;
      pointer-events: none;
    }
    header.hero::after {
      content: '';
      position: absolute;
      bottom: -20%;
      left: 5%;
      width: 300px;
      height: 300px;
      background: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 200 200"><defs><linearGradient id="grad" x1="0%" y1="0%" x2="100%" y2="100%"><stop offset="0%" style="stop-color:rgba(255,255,255,0.05)"/><stop offset="100%" style="stop-color:rgba(255,255,255,0.01)"/></linearGradient></defs><circle cx="100" cy="100" r="80" fill="url(%23grad)"/><path d="M60 100 L140 100 M100 60 L100 140" stroke="rgba(255,255,255,0.1)" stroke-width="2"/><circle cx="100" cy="100" r="40" fill="none" stroke="rgba(255,255,255,0.08)" stroke-width="1.5"/></svg>') no-repeat center;
      pointer-events: none;
      opacity: 0.6;
    }
    header.hero > * { position: relative; z-index: 1; }
    .hero h1 { font-size: 2.2rem; letter-spacing: -0.03em; margin-bottom: 10px; color: #ffffff; font-weight: 800; }
    .hero p { color: rgba(255,255,255,0.9); line-height: 1.6; max-width: 640px; font-size: 1rem; }
    .badge { 
      display: inline-flex; 
      align-items: center; 
      gap: 8px; 
      background: rgba(255, 255, 255, 0.2); 
      color: #ffffff; 
      padding: 8px 14px; 
      border-radius: 999px; 
      font-weight: 700; 
      font-size: 0.95rem;
      backdrop-filter: blur(10px);
      border: 1px solid rgba(255,255,255,0.3);
      margin-bottom: 12px;
    }
    .badge::before {
      content: '‚öôÔ∏è';
      font-size: 1.1rem;
    }
    
    .stat-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 12px; }
    .stat { 
      background: rgba(255,255,255,0.1); 
      border: 1px solid rgba(255,255,255,0.2);
      border-radius: 12px; 
      padding: 14px 16px;
      backdrop-filter: blur(10px);
    }
    .stat .label { color: rgba(255,255,255,0.8); font-size: 0.85rem; font-weight: 600; }
    .stat .value { font-weight: 800; font-size: 1.3rem; margin-top: 6px; color: #ffffff; }

    .card-grid { display: grid; gap: 16px; grid-template-columns: repeat(auto-fit, minmax(380px, 1fr)); }
    .card {
      background: var(--panel);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      padding: 20px;
      box-shadow: var(--shadow-sm);
      display: flex;
      flex-direction: column;
      gap: 14px;
      transition: all 300ms ease;
      position: relative;
      overflow: hidden;
    }
    .card::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 3px;
      background: var(--gradient-primary);
    }
    .card.card-health::before { background: linear-gradient(135deg, #06b6d4, #10b981); }
    .card.card-chat::before { background: linear-gradient(135deg, #ec4899, #f59e0b); }
    .card.card-url::before { background: linear-gradient(135deg, #8b5cf6, #06b6d4); }
    .card.card-files::before { background: linear-gradient(135deg, #6366f1, #14b8a6); }
    .card.card-folder::before { background: linear-gradient(135deg, #14b8a6, #10b981); }
    .card.card-reset::before { background: linear-gradient(135deg, #f59e0b, #ef4444); }
    .card.card-sitemap::before { background: linear-gradient(135deg, #22c55e, #10b981); }
    .card::after {
      content: '';
      position: absolute;
      top: -20px;
      right: -20px;
      width: 140px;
      height: 140px;
      background: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 200 200"><circle cx="100" cy="100" r="60" fill="none" stroke="rgba(255,255,255,0.04)" stroke-width="3"/><circle cx="100" cy="100" r="45" fill="none" stroke="rgba(255,255,255,0.02)" stroke-width="2"/></svg>') no-repeat center;
      pointer-events: none;
      opacity: 0.5;
    }
    .card:hover { 
      border-color: var(--primary);
      box-shadow: 0 12px 32px rgba(99, 102, 241, 0.15);
      transform: translateY(-2px);
    }
    .card h2 { 
      font-size: 1.1rem; 
      display: flex; 
      align-items: center; 
      gap: 10px; 
      color: var(--ink-strong);
      font-weight: 700;
    }
    .card p { color: var(--muted); font-size: 0.95rem; line-height: 1.5; }
    
    label { display: block; font-weight: 700; margin-bottom: 8px; color: var(--ink); font-size: 0.95rem; }
    input, textarea, select {
      width: 100%;
      padding: 12px 14px;
      border: 1px solid var(--border);
      border-radius: 12px;
      background: var(--bg-secondary);
      color: var(--ink);
      font: inherit;
      transition: all 200ms ease;
    }
    input:focus, textarea:focus, select:focus {
      outline: none;
      border-color: var(--primary);
      box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
    }
    textarea { min-height: 120px; resize: vertical; }
    
    button {
      cursor: pointer;
      border: none;
      border-radius: 12px;
      padding: 12px 16px;
      font-weight: 700;
      color: #ffffff;
      background: var(--gradient-primary);
      transition: all 200ms cubic-bezier(0.4, 0, 0.2, 1);
      box-shadow: 0 12px 28px rgba(99, 102, 241, 0.3);
      font-size: 0.95rem;
    }
    button:hover { 
      transform: translateY(-2px);
      box-shadow: 0 16px 36px rgba(99, 102, 241, 0.4);
    }
    button:disabled { opacity: 0.5; cursor: not-allowed; transform: none; box-shadow: none; }
    
    .muted { color: var(--muted); font-size: 0.92rem; }
    .row { display: flex; gap: 12px; flex-wrap: wrap; }
    .row > * { flex: 1 1 180px; }
    
    pre {
      background: #0a0e27;
      color: #a8d5ff;
      padding: 14px;
      border-radius: 12px;
      max-height: 260px;
      overflow: auto;
      font-size: 0.9rem;
      line-height: 1.5;
      border: 1px solid var(--border);
      font-family: 'Monaco', 'Courier New', monospace;
    }
    
    .top-row { display: grid; gap: 16px; grid-template-columns: 1.2fr 1fr; }
    .pill-input { display: flex; flex-direction: column; gap: 10px; }
    .pill-input input { background: rgba(255, 255, 255, 0.05); border-color: rgba(255, 255, 255, 0.1); }
    
    .section-tag { 
      font-size: 0.85rem; 
      text-transform: uppercase; 
      letter-spacing: 0.12em; 
      color: var(--primary);
      font-weight: 700;
    }
    
    .inline { display: inline-flex; align-items: center; gap: 8px; flex-wrap: wrap; color: var(--muted); }
    
    ul { padding-left: 20px; }
    ul li { margin-bottom: 6px; line-height: 1.6; color: var(--muted); }
    
    @media (max-width: 1100px) { 
      .page { flex-direction: column; } 
      .sidebar { width: 100%; position: static; } 
      .top-row { grid-template-columns: 1fr; } 
      header.hero { grid-template-columns: 1fr; } 
    }
  </style>
</head>
<body>
  <div class="page">
    <aside class="sidebar">
      <h2>Navigation</h2>
      <div class="nav">
        <a href="#overview">Overview</a>
        <a href="#health">Health</a>
        <a href="#chat">Chat</a>
        <a href="#url">Ingest URL</a>
        <a href="#files">Ingest Files</a>
        <a href="#folder">Process Folder</a>
        <a href="#reset">Reset Tracking</a>
      </div>
    </aside>

    <div class="content">
      <header class="hero" id="overview">
        <div>
          <div class="badge">Admin Console ¬∑ RAG Ops</div>
          <h1>Operate the chatbot with confidence</h1>
          <p>Trigger ingestion, scrape sites, validate health, and run test chats without touching Swagger. Designed for daily operational use.</p>
        </div>
        <div class="pill-input">
          <label for="apiBase">API Base URL</label>
          <input id="apiBase" type="text" value="" />
          <span class="muted">Defaults to this origin. Change if the API is hosted elsewhere.</span>
          <div class="stat-grid" style="margin-top: 8px;">
            <div class="stat">
              <div class="label">Environment</div>
              <div class="value" id="envLabel">Unknown</div>
            </div>
            <div class="stat">
              <div class="label">Last check</div>
              <div class="value" id="lastCheck">‚Äì</div>
            </div>
          </div>
        </div>
      </header>

      <section class="card-grid top-row" id="health">
        <div class="card card-health">
          <div class="section-tag">üè• Health</div>
          <h2>Health Check</h2>
          <p>Verify service status, version, and active model.</p>
          <button id="healthBtn">Run health check</button>
          <pre id="healthOut">Awaiting request‚Ä¶</pre>
        </div>
        <div class="card">
          <div class="section-tag">üí° Tips</div>
          <h2>Quick Guide</h2>
          <p class="muted">Use session IDs to keep conversation memory, and ingest smaller batches to avoid long-running uploads.</p>
          <ul style="color: var(--ink); padding-left: 18px; line-height: 1.6;">
            <li>‚úì Prefer HTTPS for remote API targets.</li>
            <li>‚úì Scrape single URLs before full-site crawls.</li>
            <li>‚úì Reset tracking only after backing up logs.</li>
          </ul>
        </div>
      </section>

      <section class="card-grid" id="chat">
        <div class="card card-chat">
          <div class="section-tag">üí¨ Chat</div>
          <h2>Send a Chat Query</h2>
          <p>Run a query through the RAG pipeline. Provide a session to reuse history.</p>
          <label for="chatQuery">Query</label>
          <textarea id="chatQuery" placeholder="Ask a question about your documents..."></textarea>
          <div class="row">
            <div>
              <label for="chatSession">Session ID (optional)</label>
              <input id="chatSession" type="text" placeholder="user-123" />
            </div>
            <div>
              <label for="chatHistory">Chat History (JSON list)</label>
              <input id="chatHistory" type="text" placeholder='[["user","hi"],["assistant","hello"]]' />
            </div>
          </div>
          <button id="chatBtn">Send chat</button>
          <pre id="chatOut">Awaiting request‚Ä¶</pre>
        </div>
      </section>

      <section class="card-grid" id="url">
        <div class="card card-url">
          <div class="section-tag">üåê URL Ingest</div>
          <h2>Ingest from URL(s)</h2>
          <p>Scrape single/multiple URLs or entire site and push to the vector store.</p>
          <label for="urlInput">URLs (one per line or comma-separated)</label>
          <textarea id="urlInput" placeholder="https://example.com/article&#10;https://example.com/blog&#10;https://docs.example.com" style="min-height: 100px;"></textarea>
          <div style="margin-top: 10px; padding: 12px; background: rgba(99, 102, 241, 0.1); border-radius: 10px; border-left: 3px solid var(--primary);">
            <label style="margin-bottom: 10px;">Ingestion Mode:</label>
            <div style="display: flex; gap: 12px; flex-wrap: wrap;">
              <div class="inline">
                <input type="radio" id="modeSingle" name="urlMode" value="single" checked />
                <label for="modeSingle" style="margin: 0;">Single URLs</label>
              </div>
              <div class="inline">
                <input type="radio" id="modeFull" name="urlMode" value="full" />
                <label for="modeFull" style="margin: 0;">Full Site (auto-discover)</label>
              </div>
            </div>
            <p class="muted" style="margin-top: 8px; font-size: 0.85rem;">‚Ä¢ Single URLs: Process each URL exactly as provided ‚Ä¢ Full Site: Auto-discover and scrape all subpages from first URL</p>
          </div>
          <button id="urlBtn" style="margin-top: 12px;">Ingest from URL(s)</button>
          <pre id="urlOut">Awaiting request‚Ä¶</pre>
        </div>
      </section>

      <section class="card-grid" id="url-cleanup">
        <div class="card card-url">
          <div class="section-tag">üßπ Cleanup</div>
          <h2>Remove Ingested URL Content</h2>
          <p>Delete vectors previously added from a specific URL or an entire domain.</p>
          <label for="deleteUrlInput">URL or Domain</label>
          <input id="deleteUrlInput" type="text" placeholder="https://example.com/page or example.com" />
          <div style="margin-top: 10px; padding: 12px; background: rgba(20, 184, 166, 0.1); border-radius: 10px; border-left: 3px solid var(--accent);">
            <label style="margin-bottom: 10px;">Delete Mode:</label>
            <div style="display: flex; gap: 12px; flex-wrap: wrap;">
              <div class="inline">
                <input type="radio" id="delModeUrl" name="delMode" value="url" checked />
                <label for="delModeUrl" style="margin: 0;">Exact URL</label>
              </div>
              <div class="inline">
                <input type="radio" id="delModeDomain" name="delMode" value="domain" />
                <label for="delModeDomain" style="margin: 0;">Whole Domain</label>
              </div>
            </div>
            <p class="muted" style="margin-top: 8px; font-size: 0.85rem;">‚Ä¢ Exact URL: deletes that page only ‚Ä¢ Domain: deletes all pages scraped from that domain</p>
          </div>
          <button id="deleteUrlBtn" style="margin-top: 12px;">Delete ingested content</button>
          <pre id="deleteUrlOut">Awaiting request‚Ä¶</pre>
        </div>
      </section>

      <section class="card-grid" id="sitemap">
        <div class="card card-sitemap">
          <div class="section-tag">üó∫Ô∏è Sitemap</div>
          <h2>Ingest from Sitemap</h2>
          <p>Auto-discover and ingest all URLs from a site's sitemap.xml (perfect for cloud deployments).</p>
          <label for="sitemapDomain">Domain</label>
          <input id="sitemapDomain" type="text" placeholder="example.com or https://example.com" />
          <div style="margin-top: 10px; padding: 12px; background: rgba(34, 197, 94, 0.1); border-radius: 10px; border-left: 3px solid var(--success);">
            <p class="muted" style="font-size: 0.85rem;">‚úì No ChromeDriver needed ‚Ä¢ Works on Azure, Docker, serverless ‚Ä¢ Discovers URLs from sitemap.xml</p>
          </div>
          <button id="sitemapBtn" style="margin-top: 12px;">Ingest from Sitemap</button>
          <pre id="sitemapOut">Awaiting request‚Ä¶</pre>
        </div>
      </section>

      <section class="card-grid" id="files">
        <div class="card card-files">
          <div class="section-tag">üìÅ Files</div>
          <h2>Upload & Ingest Files</h2>
          <p>Upload PDF, DOCX, or TXT documents and add them to FAISS.</p>
          <input id="fileInput" type="file" multiple />
          <button id="fileBtn">Upload and ingest</button>
          <pre id="fileOut">Awaiting request‚Ä¶</pre>
        </div>
      </section>

      <section class="card-grid" id="folder">
        <div class="card card-folder">
          <div class="section-tag">üîÑ Auto-Ingest</div>
          <h2>Process Documents Folder</h2>
          <p>Run ingestion for new or changed files in the configured documents folder.</p>
          <button id="folderBtn">Process documents folder</button>
          <pre id="folderOut">Awaiting request‚Ä¶</pre>
        </div>
      </section>

      <section class="card-grid" id="reset">
        <div class="card card-reset">
          <div class="section-tag">‚ö†Ô∏è Maintenance</div>
          <h2>Reset Tracking</h2>
          <p>Clear file tracking so the next run reprocesses every document.</p>
          <button id="resetBtn" style="background: linear-gradient(135deg, #f59e0b 0%, #ef4444 100%); color: #ffffff; box-shadow: 0 12px 28px rgba(245, 158, 11, 0.3);">Reset tracking</button>
          <pre id="resetOut">Awaiting request‚Ä¶</pre>
        </div>
      </section>
    </div>
  </div>

  <script>
    const apiBaseInput = document.getElementById('apiBase');
    apiBaseInput.value = window.location.origin;

    const setLoading = (btn, loading) => {
      if (!btn) return;
      btn.disabled = loading;
      btn.textContent = loading ? 'Working‚Ä¶' : btn.dataset.label || btn.textContent;
    };

    const format = (data) => {
      try { return JSON.stringify(data, null, 2); } catch (e) { return String(data); }
    };

    const updateMeta = (result) => {
      const envLabel = document.getElementById('envLabel');
      const lastCheck = document.getElementById('lastCheck');
      const fullSiteRadio = document.getElementById('modeFull');
      
      if (result && typeof result === 'object') {
        envLabel.textContent = result.service ? result.service : 'Detected';
        lastCheck.textContent = new Date().toLocaleTimeString();
        
        // Check if full site scraping is available
        const capabilities = result.capabilities || {};
        const fullSiteAvailable = capabilities.full_site_scraping !== false;
        
        if (!fullSiteAvailable) {
          fullSiteRadio.disabled = true;
          fullSiteRadio.parentElement.style.opacity = '0.5';
          fullSiteRadio.parentElement.style.cursor = 'not-allowed';
          const label = fullSiteRadio.nextElementSibling;
          if (label) label.textContent += ' (ChromeDriver unavailable)';
        }
      }
    };

    // Auto-run health check on page load
    window.addEventListener('load', () => {
      const healthBtn = document.getElementById('healthBtn');
      const healthOut = document.getElementById('healthOut');
      setLoading(healthBtn, true);
      healthOut.textContent = 'Auto-checking health...';
      handle({ path: '/health', button: healthBtn, output: healthOut });
    });

    const handle = async ({ path, method = 'GET', body, isForm = false, button, output }) => {
      const base = apiBaseInput.value.trim() || window.location.origin;
      const target = base.replace(/\/$/, '') + path;
      if (button) {
        button.dataset.label = button.dataset.label || button.textContent;
        setLoading(button, true);
      }
      output.textContent = 'Loading...';
      try {
        const opts = { method, headers: {} };
        if (isForm) {
          opts.body = body;
        } else if (body) {
          opts.headers['Content-Type'] = 'application/json';
          opts.body = JSON.stringify(body);
        }
        const res = await fetch(target, opts);
        const text = await res.text();
        let data;
        try { data = JSON.parse(text); } catch { data = text; }
        output.textContent = format(data);
        if (path === '/health') updateMeta(data);
      } catch (err) {
        output.textContent = `Error: ${err}`;
      } finally {
        if (button) setLoading(button, false);
      }
    };

    document.getElementById('healthBtn').addEventListener('click', () => {
      handle({ path: '/health', button: document.getElementById('healthBtn'), output: document.getElementById('healthOut') });
    });

    document.getElementById('chatBtn').addEventListener('click', () => {
      const query = document.getElementById('chatQuery').value.trim();
      const session_id = document.getElementById('chatSession').value.trim() || null;
      const historyRaw = document.getElementById('chatHistory').value.trim();
      let chat_history = undefined;
      if (historyRaw) {
        try { chat_history = JSON.parse(historyRaw); } catch (e) {
          document.getElementById('chatOut').textContent = 'Invalid chat history JSON.';
          return;
        }
      }
      if (!query) {
        document.getElementById('chatOut').textContent = 'Please enter a query.';
        return;
      }
      handle({
        path: '/chat',
        method: 'POST',
        body: { query, session_id, chat_history },
        button: document.getElementById('chatBtn'),
        output: document.getElementById('chatOut')
      });
    });

    document.getElementById('urlBtn').addEventListener('click', () => {
      const input = document.getElementById('urlInput').value.trim();
      const mode = document.querySelector('input[name="urlMode"]:checked').value;
      
      if (!input) {
        document.getElementById('urlOut').textContent = 'Please enter URL(s).';
        return;
      }
      
      // Parse multiple URLs (comma-separated or newline-separated)
      const urlList = input
        .split(/[,\n]/)
        .map(u => u.trim())
        .filter(u => u.length > 0);
      
      if (urlList.length === 0) {
        document.getElementById('urlOut').textContent = 'Please enter valid URL(s).';
        return;
      }
      
      // If multiple URLs and single mode, process each separately
      if (urlList.length > 1 && mode === 'single') {
        processMultipleUrls(urlList);
      } else if (mode === 'full') {
        // Full site mode - warn about ChromeDriver requirement
        const url = urlList[0];
        document.getElementById('urlOut').textContent = 'Attempting full-site discovery...\n(Note: Requires ChromeDriver. On Azure/cloud, use Single URLs mode if it fails.)';
        handle({
          path: '/ingest/url',
          method: 'POST',
          body: { url, scrape_full_site: true },
          button: document.getElementById('urlBtn'),
          output: document.getElementById('urlOut')
        });
      } else {
        // Single URL mode
        const url = urlList[0];
        handle({
          path: '/ingest/url',
          method: 'POST',
          body: { url, scrape_full_site: false },
          button: document.getElementById('urlBtn'),
          output: document.getElementById('urlOut')
        });
      }
    });
    
    const processMultipleUrls = async (urls) => {
      const output = document.getElementById('urlOut');
      const btn = document.getElementById('urlBtn');
      btn.dataset.label = btn.dataset.label || btn.textContent;
      setLoading(btn, true);
      output.textContent = `Processing ${urls.length} URLs...\n\n`;
      
      const results = [];
      for (let i = 0; i < urls.length; i++) {
        const url = urls[i];
        output.textContent += `[${i + 1}/${urls.length}] Processing: ${url}\n`;
        
        try {
          const base = document.getElementById('apiBase').value.trim() || window.location.origin;
          const target = base.replace(/\/$/, '') + '/ingest/url';
          const res = await fetch(target, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ url, scrape_full_site: false })
          });
          const text = await res.text();
          let data = JSON.parse(text);
          results.push({ url, success: res.ok, data });
          output.textContent += `‚úì Success: ${data.message || 'OK'}\n\n`;
        } catch (err) {
          results.push({ url, success: false, error: String(err) });
          output.textContent += `‚úó Error: ${err}\n\n`;
        }
      }
      
      output.textContent += `\n=== Summary ===\nTotal: ${urls.length}\nSuccessful: ${results.filter(r => r.success).length}\nFailed: ${results.filter(r => !r.success).length}`;
      setLoading(btn, false);
    };

    // Delete ingested URL/domain
    document.getElementById('deleteUrlBtn').addEventListener('click', async () => {
      const raw = document.getElementById('deleteUrlInput').value.trim();
      const mode = document.querySelector('input[name="delMode"]:checked').value;
      const output = document.getElementById('deleteUrlOut');
      const btn = document.getElementById('deleteUrlBtn');

      if (!raw) {
        output.textContent = 'Enter a URL or domain to delete.';
        return;
      }

      const payload = mode === 'domain'
        ? { domain: raw }
        : { url: raw };

      btn.dataset.label = btn.dataset.label || btn.textContent;
      setLoading(btn, true);
      output.textContent = 'Deleting...';

      try {
        const base = document.getElementById('apiBase').value.trim() || window.location.origin;
        const target = base.replace(/\/$/, '') + '/ingest/url/delete';
        const res = await fetch(target, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(payload)
        });
        const text = await res.text();
        let data;
        try { data = JSON.parse(text); } catch { data = text; }
        output.textContent = format(data);
      } catch (err) {
        output.textContent = `Error: ${err}`;
      } finally {
        setLoading(btn, false);
      }
    });

    document.getElementById('fileBtn').addEventListener('click', () => {
      const files = document.getElementById('fileInput').files;
      if (!files || !files.length) {
        document.getElementById('fileOut').textContent = 'Please select files to upload.';
        return;
      }
      const fd = new FormData();
      for (const f of files) fd.append('files', f);
      handle({
        path: '/ingest/docs',
        method: 'POST',
        body: fd,
        isForm: true,
        button: document.getElementById('fileBtn'),
        output: document.getElementById('fileOut')
      });
    });

    document.getElementById('folderBtn').addEventListener('click', () => {
      handle({
        path: '/ingest/folder',
        method: 'POST',
        button: document.getElementById('folderBtn'),
        output: document.getElementById('folderOut')
      });
    });

    document.getElementById('resetBtn').addEventListener('click', () => {
      handle({
        path: '/ingest/folder/reset',
        method: 'POST',
        button: document.getElementById('resetBtn'),
        output: document.getElementById('resetOut')
      });
    });

    // Ingest from sitemap
    document.getElementById('sitemapBtn').addEventListener('click', async () => {
      const domain = document.getElementById('sitemapDomain').value.trim();
      const output = document.getElementById('sitemapOut');
      const btn = document.getElementById('sitemapBtn');

      if (!domain) {
        output.textContent = 'Please enter a domain.';
        return;
      }

      btn.dataset.label = btn.dataset.label || btn.textContent;
      setLoading(btn, true);
      output.textContent = 'Discovering URLs from sitemap...\n(This may take a moment)\n';

      try {
        const base = document.getElementById('apiBase').value.trim() || window.location.origin;
        const target = base.replace(/\/$/, '') + '/ingest/sitemap';
        const res = await fetch(target, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ domain })
        });
        const text = await res.text();
        let data;
        try { data = JSON.parse(text); } catch { data = text; }
        
        output.textContent = format(data);
        
        if (res.ok && data.chunks_created > 0) {
          output.textContent += '\n\n‚úÖ Sitemap ingestion completed successfully!';
        }
      } catch (err) {
        output.textContent = `Error: ${err}`;
      } finally {
        setLoading(btn, false);
      }
    });
  </script>
</body>
</html>
