name: Deploy to Azure

on:
  workflow_dispatch:
    inputs:
      environment:
        description: 'Deployment environment'
        required: true
        type: choice
        options:
          - production
          - staging
      image_tag:
        description: 'Docker image tag to deploy'
        required: false
        default: 'latest'
  workflow_run:
    workflows: ["Push to Registry"]
    types:
      - completed
    branches:
      - main

env:
  AZURE_WEBAPP_NAME: ragchatbot-app  # Replace with your Azure Web App name
  
jobs:
  deploy-production:
    name: Deploy to Production
    runs-on: ubuntu-latest
    if: |
      (github.event_name == 'workflow_run' && github.event.workflow_run.conclusion == 'success' && github.ref == 'refs/heads/main') ||
      (github.event_name == 'workflow_dispatch' && github.event.inputs.environment == 'production')
    environment:
      name: production
      url: ${{ steps.deploy.outputs.webapp-url }}
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Log in to Azure
      uses: azure/login@v1
      with:
        creds: ${{ secrets.AZURE_CREDENTIALS }}
        
    - name: Set image tag
      id: set-tag
      run: |
        if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
          echo "tag=${{ github.event.inputs.image_tag }}" >> $GITHUB_OUTPUT
        else
          echo "tag=latest" >> $GITHUB_OUTPUT
        fi
        
    - name: Deploy to Azure Web App
      id: deploy
      uses: azure/webapps-deploy@v3
      with:
        app-name: ${{ env.AZURE_WEBAPP_NAME }}
        images: ${{ secrets.AZURE_REGISTRY_LOGIN_SERVER }}/ragchatbot:${{ steps.set-tag.outputs.tag }}
        
    - name: Configure App Settings
      uses: azure/appservice-settings@v1
      with:
        app-name: ${{ env.AZURE_WEBAPP_NAME }}
        app-settings-json: |
          [
            {
              "name": "OPENAI_API_KEY",
              "value": "${{ secrets.OPENAI_API_KEY }}",
              "slotSetting": false
            },
            {
              "name": "MODEL_NAME",
              "value": "gpt-4o-mini",
              "slotSetting": false
            },
            {
              "name": "WEBSITES_PORT",
              "value": "8000",
              "slotSetting": false
            },
            {
              "name": "WEBSITES_ENABLE_APP_SERVICE_STORAGE",
              "value": "true",
              "slotSetting": false
            },
            {
              "name": "USE_HUGGINGFACE_EMBEDDINGS",
              "value": "false",
              "slotSetting": false
            },
            {
              "name": "USE_HUGGINGFACE_LLM",
              "value": "false",
              "slotSetting": false
            }
          ]
          
    - name: Health check
      run: |
        echo "Waiting 30 seconds for app to start..."
        sleep 30
        echo "Running health check..."
        curl -f ${{ steps.deploy.outputs.webapp-url }}/health || exit 1
        echo "âœ… Health check passed!"
        
    - name: Deployment summary
      run: |
        echo "### ðŸš€ Deployment Successful!" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "**Environment:** Production" >> $GITHUB_STEP_SUMMARY
        echo "**Application URL:** ${{ steps.deploy.outputs.webapp-url }}" >> $GITHUB_STEP_SUMMARY
        echo "**Image:** ${{ secrets.AZURE_REGISTRY_LOGIN_SERVER }}/ragchatbot:${{ steps.set-tag.outputs.tag }}" >> $GITHUB_STEP_SUMMARY
        echo "**Deployed at:** $(date)" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### ðŸ“Š Quick Links" >> $GITHUB_STEP_SUMMARY
        echo "- [Application](${{ steps.deploy.outputs.webapp-url }})" >> $GITHUB_STEP_SUMMARY
        echo "- [API Docs](${{ steps.deploy.outputs.webapp-url }}/docs)" >> $GITHUB_STEP_SUMMARY
        echo "- [Health Check](${{ steps.deploy.outputs.webapp-url }}/health)" >> $GITHUB_STEP_SUMMARY

  deploy-staging:
    name: Deploy to Staging
    runs-on: ubuntu-latest
    if: github.event_name == 'workflow_dispatch' && github.event.inputs.environment == 'staging'
    environment:
      name: staging
      url: ${{ steps.deploy.outputs.webapp-url }}
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Log in to Azure
      uses: azure/login@v1
      with:
        creds: ${{ secrets.AZURE_CREDENTIALS }}
        
    - name: Deploy to Azure Web App (Staging)
      id: deploy
      uses: azure/webapps-deploy@v3
      with:
        app-name: ${{ env.AZURE_WEBAPP_NAME }}-staging
        images: ${{ secrets.AZURE_REGISTRY_LOGIN_SERVER }}/ragchatbot:${{ github.event.inputs.image_tag || 'develop' }}
        
    - name: Configure App Settings
      uses: azure/appservice-settings@v1
      with:
        app-name: ${{ env.AZURE_WEBAPP_NAME }}-staging
        app-settings-json: |
          [
            {
              "name": "OPENAI_API_KEY",
              "value": "${{ secrets.OPENAI_API_KEY }}",
              "slotSetting": false
            },
            {
              "name": "MODEL_NAME",
              "value": "gpt-4o-mini",
              "slotSetting": false
            },
            {
              "name": "WEBSITES_PORT",
              "value": "8000",
              "slotSetting": false
            }
          ]
          
    - name: Health check
      run: |
        sleep 30
        curl -f ${{ steps.deploy.outputs.webapp-url }}/health || exit 1
        
    - name: Deployment summary
      run: |
        echo "### ðŸš€ Staging Deployment Successful!" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "**Application URL:** ${{ steps.deploy.outputs.webapp-url }}" >> $GITHUB_STEP_SUMMARY
